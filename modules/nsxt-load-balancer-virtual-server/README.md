# VMWare NSX-T Load Balancer Virtual Server Module
This Terraform module configures NSX-T load balancer virtual servers.

# Execution environment
This module requires Terraform 1.x.

## Config Data Object Definition
| Variable  | Description | Type | Default |
| ---      |  ------  |----------| ----|
| `resource_description` | A string added to the description field of all created resources | `string` | `Terraform provisioned` |
| `display_name` | The name assigned to the LB virtual server created with this module | `string` | |
| `access_log_enabled` | Enables/disables the virtual server access log. | `bool` | `true` |
| `application_profile_path` | Application profile path for this virtual server. Note that this also differentiates between Layer 4 TCP/UDP and Layer 7 HTTP virtual servers. | `string` | `null` |
| `enabled` | Enables/disables this virtual server. | `bool` | `true` |
| `ip_address` | IP Address for this virtual server | `string` | |
| `default_pool_member_ports` | The default members ports to use when members do not specify their listening ports | `list(number)` | `[]` |
| `log_significant_event_only` | Should only signficant events be logged to the access log. Requires `access_log_enabled` be true | `bool` | |
| `max_concurrent_connections` | Maximum concurrent connections for the virtual server | `number` | |
| `max_new_connection_rate` | New connection rate limit for the virtual server. Serves as a rate limiter. | `number` | |
| `persistence_profile_path` | NSX resource path to a persistence profile which defines connection persistence for this virtual server | `string` | |
| `pool_path` | NSX resource path to the load balancer pool which will service requests | `string` | |
| `ports` | Ports the virtual server will listen on | `list(string)` | |
| `sorry_pool_path` | The NSX resource path to a load balancer pool to service requests when the main pool is unavailable | `string` | |
| `service_path` | The load balancer service to associate this virtual server with | `string` | |
| `tags` | A map of tag:scope pairs to be assigned to created resources | `string` | |
| `access_list_control` | An object defined with the below attributes. It defines IP access control lists to control client connections | `object` | `null` |
| `access_list_control.enabled` | Enables/disables the access control function for this virtual server. | `bool` | |
| `access_list_control.action` | Action to take on a match. Can be `ALLOW` or `DROP` | `string` | |
| `access_list_control.group_path` | The NSX resource path of grouping object which defines the IP addresses or ranges to match the client IPs | `string` | |
| `client_ssl` | An object defined with the below attributes. It defines SSL options for connections between the virtual server and clients| `object` | `null` |
| `client_ssl.default_certificate_path` | A NSX resource path to a certificate which is used if the virtual service does not host multiple hostnames or if the client does not support SNI.| `string` | |
| `client_ssl.client_auth` | Whether to require certificate authentication for clients. Can be either `REQUIRED` or `IGNORE` | `string` | `IGNORE` |
| `client_ssl.certificate_chain_depth` | Maximum depth of a client's ssl certificate chain | `number` | `3` |
| `client_ssl.ca_paths` | NSX resource path to CA certificates that are used to validate client certificates when `client_auth` is `REQUIRED`| `list(string)` | `null` |
| `client_ssl.crl_paths` | NSX resource path to certificate revocation lists that clients are checked against| `list(string)` | `null` |
| `client_ssl.sni_paths` | NSX resources paths to SNI TLS certificates | `list(string)` | `null` |
| `client_ssl.ssl_profile_path` | NSX resource path to a ssl options profile (accepted ciphers, etc) for this virtual server | `string` | `null` |
| `server_ssl` | An object defined with the below attributes. It defines SSL options for connections between the virtual server and lb pool members | `object` | `null` |
| `server_ssl.server_auth` | Whether to validate pool member SSL certificates. Can be `AUTO_APPLY` `REQUIRED` or `IGNORE` | `string` | `IGNORE` |
| `server_ssl.certificate_chain_depth` | Maximum depth of a client's ssl certificate chain | `number` | `3` |
| `server_ssl.ca_paths` | NSX resource path to CA certificates that are used to validate client certificates when `client_auth` is `REQUIRED`| `list(string)` | `null` |
| `server_ssl.crl_paths` | NSX resource path to certificate revocation lists that pool members are checked against| `list(string)` | `null` |
| `server_ssl.sni_paths` | NSX resources paths to SNI TLS certificates | `list(string)` | `null` |
| `server_ssl.ssl_profile_path` | NSX resource path to a ssl options profile (accepted ciphers, etc) for this virtual server | `string` | `null` |
| `rules` | An object defined with the below attributes. It defines virtual server request/response conditions and actions | `map(object)` | {} |
| `rules.match_strategy` | | |
| `rules.phase` | Load balancer processing phase, one of `HTTP_REQUEST_REWRITE`, `HTTP_FORWARDING`, `HTTP_RESPONSE_REWRITE`, `HTTP_ACCESS` or `TRANSPORT` | `string` | `HTTP_FORWARDING` (NSX-T Provider Default). See the Actions to Phases table and the Conditions to Phases map to understand which actions and conditions may be used with each phase. |
| `rules.actions` | A list of actions objects to apply to the rule. Actions object defined with the below attributes. | | |
| `rules.actions.http_redirect` | Action used to redirect requests | | |
| `rules.actions.http_redirect.redirect_status` | HTTP status code used in redirection. Eg. 3xx | `string` | |
| `rules.actions.http_redirect.redirect_url` | Destination URL which connections will be redirected to | `string` | |
| `rules.actions.http_reject` | Action used to reject requests | | |
| `rules.actions.http_reject.reply_status` | HTTP_status code used when rejecting connections | `string` | |
| `rules.actions.http_reject.reply_message` | Response message when rejecting connections | `string` | |
| `rules.actions.select_pool` | Action used to select a load balancer pool for inbound connection | | |
| `rules.actions.select_pool.pool_id` | Resource path to NSX-T load balancer pool to direct request to | `string` | |
| `rules.actions.variable_assignment` | Action used to create variables and assign values to variables | | |
| `rules.actions.variable_assignment.variable_name` | Name of the variable to assign a value to | `string` | |
| `rules.actions.variable_assignment.variable_value` | Value to assign to the variable | `string` | |
| `rules.actions.variable_persistence_learn` | Action used to select a load balancer pool for inbound connection | | |
| `rules.actions.variable_persistence_learn.variable_name` | Action used to select a load balancer pool for inbound connection | |
| `rules.actions.variable_persistence_learn.variable_hash_enabled` | Whether to enable a hash operation for variable value | `bool` |`false` (NSX-T Provider Default)|
| `rules.actions.variable_persistence_learn.persistence_profile_path` | Path to NSX-T persistence profile path | `string` | |
| `rules.actions.variable_persistence_on` | Action used to inspect load balancer pool for inbound connection | | |
| `rules.actions.variable_persistence_on.variable_name` | Name of variable to inspect for a value | `string` | |
| `rules.actions.variable_persistence_on.variable_hash_enabled` | Whether to enable a hash operation for variable value | `bool` |`false` (NSX-T Provider Default)|
| `rules.actions.variable_persistence_learn.persistence_profile_path` | Path to NSX-T persistence profile path | `string` | |
| `rules.actions.http_response_header_rewrite` | Action used to rewrite http header values for matched responses | | |
| `rules.actions.http_response_header_rewrite.header_name` | Name of header to rewrite | `string` | |
| `rules.actions.http_response_header_rewrite.header_value` | Value to assign to header | `string` | |
| `rules.actions.http_response_header_delete` | Action used to delete http headers in matched responses | | |
| `rules.actions.http_response_header_delete.header_name` | Name of header to delete | `string` | |
| `rules.actions.http_request_uri_rewrite` | Action used to rewrite URIs in matched requests | | |
| `rules.actions.http_request_uri_rewrite.uri` | New URI (path portion of URL) | `string` | |
| `rules.actions.http_request_uri_rewrite.uri_arguments` | Query portion of URI (Eg. foo=bar&bar=foo)| `string` | |
| `rules.actions.http_request_header_rewrite` | Action used to rewrite http headers to new values in matched requests | | |
| `rules.actions.http_request_header_rewrite.header_name` | Header name to rewrite | `string` | |
| `rules.actions.http_request_header_rewrite.header_value` | New header value | `string` | |
| `rules.actions.http_request_header_delete` | Action used to delete http headers in matched requests | | |
| `rules.actions.http_request_header_delete.header_name` | Header name to delete | `string` | |
| `rules.actions.jwt_auth` | Action used to control access to backend resources using JWT authentication | | |
| `rules.actions.jwt_auth.key` | Object defining the key used to verify JWT signatures | | |
| `rules.actions.jwt_auth.key.certificate_path` | NSX-T path to certificate used to verify JWTs | `string` | |
| `rules.actions.jwt_auth.key.public_key_content` | Public key content used to verify JWTs | `string` | |
| `rules.actions.jwt_auth.pass_jwt_to_pool` | Whether to pass the JWT on to the backend server or remove it | `bool` | `false` (NSX-T Provider default) |
| `rules.actions.jwt_auth.realm` | The protected realm | `string` | |
| `rules.actions.jwt_auth.tokens` | Tokens to search for JWT message. NSX-T defaults to bearer tokens in the `Authorization` header | `list(string)` | |
| `rules.actions.ssl_mode_selection` | Action used to select the SSL mode for the connection | | |
| `rules.actions.ssl_mode_selection.ssl_mode` | The SSL mode. Can be `SSL_PASSTHROUGH`, `SSL_END_TO_END`, or `SSL_OFFLOAD` | `string` | |
| `rules.actions.connection_drop` | Action used to drop the connection | | |
| `rules.conditions` | A list of conditions objects to apply to the rule. Conditions object defined with the below attributes | | |
| `rules.conditions.https_request_method` | Condition used to match the method of HTTP requests | | |
| `rules.conditions.https_request_method.method` | The HTTP method to match (Eg. GET) | `string` | |
| `rules.conditions.https_request_method.inverse` | Flag to invert the match behavior | `bool` | `false` (NSX-T Provider default) |
| `rules.conditions.https_request_version` | Condition to match the HTTP version of a request | | |
| `rules.conditions.https_request_version.version` | The HTTP version | `string` | |
| `rules.conditions.https_request_version.inverse` | Flag to invert the match behavior | `bool` | `false` (NSX-T Provider default) |
| `rules.conditions.ip_header` | Condition used to match IP header fields of HTTP requests | | |
| `rules.conditions.ip_header.group_path` | NSX-T resource path to an IP address group to match requests against | `string` | |
| `rules.conditions.ip_header.source_address` | IP address or CIDR to match client requests against. Eg. 192.168.1.54, 192.168.0.0/24 | `string` | |
| `rules.conditions.ip_header.inverse` | Flag to invert the match behavior | `bool` | `false` (NSX-T Provider default) |
| `rules.conditions.tcp_header` | Condition used to match TCP header of HTTP messages | | |
| `rules.conditions.tcp_header.source_port` | The TCP source port of the HTTP request | `string` | |
| `rules.conditions.tcp_header.inverse` | Flag to invert the match behavior | `bool` | `false` (NSX-T Provider default) |
| `rules.conditions.http_request_header` | Condition used to match HTTP requests by HTTP header | | |
| `rules.conditions.http_request_header.header_name` | Name of the header | `string` | |
| `rules.conditions.http_request_header.header_value` | Value of the header | `string` | |
| `rules.conditions.http_request_header.inverse` | Flag to invert the match behavior | `bool` | `false` (NSX-T Provider default) |
| `rules.conditions.http_request_header.match_type` | The match type used. Can be `STARTS_WITH`, `ENDS_WITH`, `EQUALS`, `CONTAINS`, or `REGEX` | `string` | `REGEX` (NSX-T Provider default) |
| `rules.conditions.http_request_header.case_sensitive` | Should matches be case sensitive | `bool` | `true` (NSX-T Provider default) |
| `rules.conditions.http_response_header` | Condition used to match HTTP responses by HTTP header | | |
| `rules.conditions.http_response_header.header_name` | Name of the header | `string` | |
| `rules.conditions.http_response_header.header_value` | Value of the header | `string` | |
| `rules.conditions.http_response_header.inverse` | Flag to invert the match behavior | `bool` | `false` (NSX-T Provider default) |
| `rules.conditions.http_response_header.match_type` | The match type used. Can be `STARTS_WITH`, `ENDS_WITH`, `EQUALS`, `CONTAINS`, or `REGEX` | `string` | `REGEX` (NSX-T Provider default) |
| `rules.conditions.http_response_header.case_sensitive` | Should matches be case sensitive | `bool` | `true` (NSX-T Provider default) |
| `rules.conditions.variable` | Condition used to match a variable name and value | | |
| `rules.conditions.variable.variable_name` | Name of the variable | `string` | |
| `rules.conditions.variable.variable_value` | Value of the variable | `string` | |
| `rules.conditions.variable.inverse` | Flag to invert the match behavior | `bool` | `false` (NSX-T Provider default) |
| `rules.conditions.variable.match_type` | The match type used. Can be `STARTS_WITH`, `ENDS_WITH`, `EQUALS`, `CONTAINS`, or `REGEX` | `string` | `REGEX` (NSX-T Provider default) |
| `rules.conditions.variable.case_sensitive` | Should matches be case sensitive | `bool` | `true` (NSX-T Provider default) |
| `rules.conditions.http_request_cookie` | Condition used to match HTTP requests by cookie | | |
| `rules.conditions.http_request_cookie.cookie_name` | Name of the cookie | `string` | |
| `rules.conditions.http_request_cookie.cookie_value` | Value of the cookie | `string` | |
| `rules.conditions.http_request_cookie.inverse` | Flag to invert the match behavior | `bool` | `false` (NSX-T Provider default) |
| `rules.conditions.http_request_cookie.match_type` | The match type used. Can be `STARTS_WITH`, `ENDS_WITH`, `EQUALS`, `CONTAINS`, or `REGEX` | `string` | `REGEX` (NSX-T Provider default) |
| `rules.conditions.http_request_cookie.case_sensitive` | Should matches be case sensitive | `bool` | `true` (NSX-T Provider default) |
| `rules.conditions.http_request_body` | Condition used to match the message body of an HTTP request | | |
| `rules.conditions.http_request_body.body_value` | The match string | `string` | |
| `rules.conditions.http_request_body.match_type` | The match type used. Can be `STARTS_WITH`, `ENDS_WITH`, `EQUALS`, `CONTAINS`, or `REGEX` | `string` | `REGEX` (NSX-T Provider default) |
| `rules.conditions.http_request_body.case_sensitive` | Should matches be case sensitive | `bool` | `true` (NSX-T Provider default) |
| `rules.conditions.http_request_body.inverse` | Flag to invert the match behavior | `bool` | `false` (NSX-T Provider default) |
| `rules.conditions.ssl_sni` | Condition used to match the SSL SNI in the client hello | | |
| `rules.conditions.ssl_sni.sni` | The SNI in the client hello llo message | `string` | |
| `rules.conditions.ssl_sni.inverse` | Flag to invert the match behavior | `bool` | `false` (NSX-T Provider default) |
| `rules.conditions.ssl_sni.match_type` | The match type used. Can be `STARTS_WITH`, `ENDS_WITH`, `EQUALS`, `CONTAINS`, or `REGEX` | `string` | `REGEX` (NSX-T Provider default) |
| `rules.conditions.ssl_sni.case_sensitive` | Should matches be case sensitive | `bool` | `true` (NSX-T Provider default) |
| `rules.conditions.http_ssl` | Condition to match properties of SSL handshake and SSL connections | | |
| `rules.conditions.http_ssl.client_certificate_issuer_dn` | Condition to match issuer DN properties of the client certificate | | |
| `rules.conditions.http_ssl.client_certificate_issuer_dn.issuer_dn` | The issuer DN | `string` | |
| `rules.conditions.http_ssl.client_certificate_issuer_dn.match_type` | The match type used. Can be `STARTS_WITH`, `ENDS_WITH`, `EQUALS`, `CONTAINS`, or `REGEX` | `string` | `REGEX` (NSX-T Provider default) |
| `rules.conditions.http_ssl.client_certificate_issuer_dn.case_sensitive` | Should matches be case sensitive | `bool` | `true` (NSX-T Provider default) |
| `rules.conditions.http_ssl.client_certificate_subject_dn` | Condition to match subject DN properties of the client certificate | | |
| `rules.conditions.http_ssl.client_certificate_subject_dn.subject_dn` | The subject DN | `string` | |
| `rules.conditions.http_ssl.client_certificate_subject_dn.match_type` | The match type used. Can be `STARTS_WITH`, `ENDS_WITH`, `EQUALS`, `CONTAINS`, or `REGEX` | `string` | `REGEX` (NSX-T Provider default) |
| `rules.conditions.http_ssl.client_certificate_subject_dn.case_sensitive` | Should matches be case sensitive | `bool` | `true` (NSX-T Provider default) |
| `rules.conditions.http_ssl.client_supported_ssl_ciphers` | Ciphers supported by the client | `list(string)` | |
| `rules.conditions.http_ssl.session_reused` | Type of SSL session reuse. Can be `IGNORE`, `REUSED`, `NEW` | `string` | |
| `rules.conditions.http_ssl.used_protocol` | Protcol of an established SSL connection. Can be `SSL_V2`, `SSL_V3`, `TLS_V1`, `TLS_V1_1`, `TLS_V1_2` | `string` | |
| `rules.conditions.http_ssl.used_ssl_cipher` | Cipher used for an established SSL connection | `string` | |
| `rules.conditions.http_ssl.inverse` | Flag to invert the match behavior | `bool` | `false` (NSX-T Provider default) |
| `rules.conditions.http_request_uri` | Condition used to match the URI (path portion) of a request | | |
| `rules.conditions.http_request_uri.uri` | The URI to match | `string` | |
| `rules.conditions.http_request_uri.inverse` | Flag to invert the match behavior | `bool` | `false` (NSX-T Provider default) |
| `rules.conditions.http_request_uri.match_type` | The match type used. Can be `STARTS_WITH`, `ENDS_WITH`, `EQUALS`, `CONTAINS`, or `REGEX` | `string` | `REGEX` (NSX-T Provider default) |
| `rules.conditions.http_request_uri.case_sensitive` | Should matches be case sensitive | `bool` | `true` (NSX-T Provider default) |
| `rules.conditions.http_request_uri_arguments` | Condition used to match the URI arguments of a requests | | |
| `rules.conditions.http_request_uri_arguments.uri_arguments` | The URI arguments to match which is the query portion of URI (Eg. foo=bar&bar=foo) | `string` | |
| `rules.conditions.http_request_uri_arguments.inverse` | Flag to invert the match behavior | `bool` | `false` (NSX-T Provider default) |
| `rules.conditions.http_request_uri_arguments.match_type` | The match type used. Can be `STARTS_WITH`, `ENDS_WITH`, `EQUALS`, `CONTAINS`, or `REGEX` | `string` | `REGEX` (NSX-T Provider default) |
| `rules.conditions.http_request_uri_arguments.case_sensitive` | Should matches be case sensitive | `bool` | `true` (NSX-T Provider default) |


## Actions to Phases
| Actions ↓ / Phases →         | HTTP_FORWARDING | HTTP_REQUEST_REWRITE | HTTP_RESPONSE_REWRITE | HTTP_ACCESS | TRANSPORT |
| ---------------------------- | :-------------: | :------------------: | :-------------------: | :---------: | :-------: |
| http_reject                  | x               |                      |                       |             |           |
| http_redirect                | x               |                      |                       |             |           |
| select_pool                  | x               |                      |                       |             |           |
| variable_persistence_on      | x               |                      |                       |             |           |
| http_request_uri_rewrite     |                 | x                    |                       |             |           |
| http_request_header_rewrite  |                 | x                    |                       |             |           |
| http_request_header_delete   |                 | x                    |                       |             |           |
| variable_assignment          |                 | x                    |                       |             |           |
| http_response_header_rewrite |                 |                      | x                     |             |           |
| http_response_header_delete  |                 |                      | x                     |             |           |
| variable_persistence_learn   |                 |                      | x                     |             |           |
| jwt_auth                     |                 |                      |                       | x           |           |
| ssl_mode_selection           |                 |                      |                       |             | x         |


## Conditions to Phases
| Conditions ↓ / Phases →    | HTTP_FORWARDING | HTTP_REQUEST_REWRITE | HTTP_RESPONSE_REWRITE | HTTP_ACCESS | TRANSPORT |
| -------------------------- |:---------------:|:--------------------:|:---------------------:|:-----------:|:---------:|
| http_request_method        |        x        |          x           |           x           |      x      |           |
| http_request_uri           |        x        |          x           |           x           |      x      |           |
| http_request_uri_arguments |        x        |          x           |           x           |      x      |           |
| http_request_version       |        x        |          x           |           x           |      x      |           |
| http_request_header        |        x        |          x           |           x           |      x      |           |
| http_request_cookie        |        x        |          x           |           x           |      x      |           |
| http_request_body          |        x        |          x           |           x           |      x      |           |
| http_response_header       |                 |                      |           x           |             |           |
| tcp_header                 |        x        |          x           |           x           |      x      |           |
| ip_header                  |        x        |          x           |           x           |      x      |           |
| variable                   |        x        |          x           |           x           |      x      |           |
| http_ssl                   |        x        |          x           |           x           |      x      |           |
| ssl_sni                    |        x        |                      |                       |             |     x     |