Copyright 2022 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

# GCVE Monitoring Module

This module contains the infrastructure to setup the [GCVE Cloud Monitoriring with a standalone agent](https://cloud.google.com/vmware-engine/docs/environment/howto-cloud-monitoring-standalone). This has been provisioned as a stateful MIG to utilize autohealing capabilities with a static IP address. To forward syslog messages, please refer to the following documentation on how to [configure a private cloud for syslog forwarding](https://cloud.google.com/vmware-engine/docs/environment/howto-cloud-monitoring-standalone#configure-private-cloud-syslog).


Notes:
* Secrets must be [created in Secret Manager](https://cloud.google.com/secret-manager/docs/create-secret) containing the values for vsphere_server (fqdn), vsphere_user (must be admin) and vsphere_password.
* The standalone agent configuration will be overriden, when executing the installer (startup-)script.

<!-- BEGIN_AUTOMATED_TF_DOCS_BLOCK -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.3.0 |
| <a name="requirement_google"></a> [google](#requirement\_google) | >= 4.35.0 |

## Usage
Basic usage of this module is as follows:

```hcl
module "example" {
	 source  = "<module-path>"

	 # Required variables
	 gcve_region  = 
	 project  = 
	 sa_gcve_monitoring  = 
	 secret_vsphere_password  = 
	 secret_vsphere_server  = 
	 secret_vsphere_user  = 
	 subnetwork  = 
	 vm_mon_name  = 
	 vm_mon_zone  = 

	 # Optional variables
	 create_dashboards  = true
	 hc_healthy_threshold  = 2
	 hc_interval_sec  = 5
	 hc_timeout_sec  = 5
	 hc_unhealthy_threshold  = 2
	 initial_delay_sec  = 180
	 vm_mon_type  = "e2-small"
}
```

## Resources

| Name | Type |
|------|------|
| [google_compute_firewall.healthcheck](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_firewall) | resource |
| [google_compute_health_check.tcp_healthcheck](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_health_check) | resource |
| [google_compute_instance_template.vm_mon_tpl](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_instance_template) | resource |
| [google_compute_region_instance_group_manager.mig_monitoring_gcve](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_region_instance_group_manager) | resource |
| [google_monitoring_dashboard.gcve_mon_dashboards](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/monitoring_dashboard) | resource |
| [google_project_iam_member.gcve_monitoring_permissions](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/project_iam_member) | resource |
| [google_project_service.enable_destination_api](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/project_service) | resource |
| [google_service_account.sa_gcve_monitoring](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/service_account) | resource |
| [google_compute_image.gcve_mon_image](https://registry.terraform.io/providers/hashicorp/google/latest/docs/data-sources/compute_image) | data source |
| [google_compute_subnetwork.gcve-subnetwork](https://registry.terraform.io/providers/hashicorp/google/latest/docs/data-sources/compute_subnetwork) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_create_dashboards"></a> [create\_dashboards](#input\_create\_dashboards) | Define if sample GCVE monitoring dashboards should be installed | `bool` | `true` | no |
| <a name="input_gcve_region"></a> [gcve\_region](#input\_gcve\_region) | Region where the Private Cloud is deployed | `string` | n/a | yes |
| <a name="input_hc_healthy_threshold"></a> [hc\_healthy\_threshold](#input\_hc\_healthy\_threshold) | How many consecutive success checks to consider the VM as healthy | `number` | `2` | no |
| <a name="input_hc_interval_sec"></a> [hc\_interval\_sec](#input\_hc\_interval\_sec) | Healthcheck interval in seconds | `number` | `5` | no |
| <a name="input_hc_timeout_sec"></a> [hc\_timeout\_sec](#input\_hc\_timeout\_sec) | Healthcheck timeout in seconds | `number` | `5` | no |
| <a name="input_hc_unhealthy_threshold"></a> [hc\_unhealthy\_threshold](#input\_hc\_unhealthy\_threshold) | How many consecutive success checks to consider the VM as unhealthy | `number` | `2` | no |
| <a name="input_initial_delay_sec"></a> [initial\_delay\_sec](#input\_initial\_delay\_sec) | How long to delay checking for healthcheck upon initialization | `number` | `180` | no |
| <a name="input_project"></a> [project](#input\_project) | The GCP project that will be used for GCVE monitoring | `string` | n/a | yes |
| <a name="input_sa_gcve_monitoring"></a> [sa\_gcve\_monitoring](#input\_sa\_gcve\_monitoring) | Service account for GCVE monitoring agent | `string` | n/a | yes |
| <a name="input_secret_vsphere_password"></a> [secret\_vsphere\_password](#input\_secret\_vsphere\_password) | The secret name containing the password for the vCenter admin user | `string` | n/a | yes |
| <a name="input_secret_vsphere_server"></a> [secret\_vsphere\_server](#input\_secret\_vsphere\_server) | The secret name conatining the FQDN of the vSphere vCenter server | `string` | n/a | yes |
| <a name="input_secret_vsphere_user"></a> [secret\_vsphere\_user](#input\_secret\_vsphere\_user) | The secret name containing the user for the vCenter server. Must be an admin user | `string` | n/a | yes |
| <a name="input_subnetwork"></a> [subnetwork](#input\_subnetwork) | Subnetwork where the VM will be deployed to | `string` | n/a | yes |
| <a name="input_vm_mon_name"></a> [vm\_mon\_name](#input\_vm\_mon\_name) | GCE VM name where GCVE monitoring agent will run | `string` | n/a | yes |
| <a name="input_vm_mon_type"></a> [vm\_mon\_type](#input\_vm\_mon\_type) | GCE VM machine type | `string` | `"e2-small"` | no |
| <a name="input_vm_mon_zone"></a> [vm\_mon\_zone](#input\_vm\_mon\_zone) | GCP zone where GCE VM will be deployed | `string` | n/a | yes |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_gcve_mon_dashboards"></a> [gcve\_mon\_dashboards](#output\_gcve\_mon\_dashboards) | GCVE Monitoring Dashboards resources |
| <a name="output_google_service_account"></a> [google\_service\_account](#output\_google\_service\_account) | The resource object of the service account for GCVE monitoring |
| <a name="output_mig_monitoring_gcve"></a> [mig\_monitoring\_gcve](#output\_mig\_monitoring\_gcve) | The name of the monitoring MIG |

<!-- END_AUTOMATED_TF_DOCS_BLOCK -->