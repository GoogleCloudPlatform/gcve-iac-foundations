/**
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


data "google_compute_network" "network-peering-peer-nw" {
  count   = var.peer_network_type == "STANDARD" ? 1 : 0
  name    = var.peer_nw_name
  project = var.peer_nw_project_id
}

data "google_vmwareengine_network" "network-peering-peer-nw" {
  count    = var.peer_network_type == "VMWARE_ENGINE_NETWORK" ? 1 : 0
  name     = var.peer_nw_name
  location = var.peer_nw_location
  project  = var.peer_nw_project_id
}

locals {
  peer_network = (

    var.peer_network_type == "VMWARE_ENGINE_NETWORK" ?
    data.google_vmwareengine_network.network-peering-peer-nw[0].id :

    var.peer_network_type == "STANDARD" ?
    data.google_compute_network.network-peering-peer-nw[0].id :

    var.peer_network_type == "PRIVATE_SERVICES_ACCESS" ?
    "projects/${var.peer_nw_project_id}/global/networks/${var.peer_nw_name}" :

    var.peer_network_type == "NETAPP_CLOUD_VOLUMES" ?
    "projects/${var.peer_nw_project_id}/global/networks/netapp-tenant-vpc" :

    var.peer_network_type == "THIRD_PARTY_SERVICE" ?
    "projects/${var.peer_nw_project_id}/global/networks/${var.peer_nw_name}" :

    var.peer_network_type == "DELL_POWERSCALE" ?
    "projects/${var.peer_nw_project_id}/global/networks/dellemc-tenant-vpc" :

    "Error: wrong peer network type"
  )
}

resource "google_vmwareengine_network_peering" "peering" {
  name                                = var.gcve_peer_name
  description                         = var.gcve_peer_description
  project                             = var.project_id
  vmware_engine_network               = var.vmware_engine_network_id
  peer_network                        = local.peer_network
  peer_network_type                   = var.peer_network_type
  export_custom_routes                = var.peer_export_custom_routes
  import_custom_routes                = var.peer_import_custom_routes
  export_custom_routes_with_public_ip = var.peer_export_custom_routes_with_public_ip
  import_custom_routes_with_public_ip = var.peer_import_custom_routes_with_public_ip
}

resource "google_vmwareengine_network_peering" "vmw-engine-network-peering" {
  count                               = var.create_remote_peer == true ? 1 : 0
  name                                = var.gcve_peer_name
  description                         = var.gcve_peer_description
  project                             = var.peer_nw_project_id
  vmware_engine_network               = var.vmware_engine_network_id
  peer_network                        = local.peer_network
  peer_network_type                   = "STANDARD"
  export_custom_routes                = var.peer_export_custom_routes
  import_custom_routes                = var.peer_import_custom_routes
  export_custom_routes_with_public_ip = var.peer_export_custom_routes_with_public_ip
  import_custom_routes_with_public_ip = var.peer_import_custom_routes_with_public_ip
}