# Copyright 2022 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: 'Tests'
on:
  push:
    branches:
    - 'main'
jobs:
  pre_run:
    name: 'setup-gh-workers'
    permissions:
      id-token: write
      contents: read
    runs-on: 'ubuntu-latest'
    steps:
    - name: Clone repo
      uses: actions/checkout@master
    - id: 'auth'
      uses: 'google-github-actions/auth@v0.4.0'
      with:
        workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_POOL_PROVIDER_NAME }} # this is the output provider_name from the TF module
        service_account: ${{ secrets.SVC_ACCOUNT_EMAIL }} # this is a SA email configured to create gh-runner MIGs
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.1.9
        terraform_wrapper: false
    - name: Terraform Init
      id: init
      run: |
        echo "bucket=\"${{ secrets.TF_BACKEND_BUCKET }}\"" > backend.tfvars
        terraform init -backend-config=backend.tfvars
      working-directory: ./test/setup/github-runners # Use your environment folder
      shell: bash
    - name: Terraform Plan
      id: plan
      run: |
        echo ${{ secrets.GH_RUNNER_TFVAR }} | base64 -d > terraform.tfvars
        terraform plan
      working-directory: ./test/setup/github-runners # Use your environment folder
      shell: bash
    - name: Terraform Apply
      id: apply
      run: |
        echo ${{ secrets.GH_RUNNER_TFVAR }} | base64 -d > terraform.tfvars
        terraform apply -auto-approve
      working-directory: ./test/setup/github-runners # Use your environment folder
      shell: bash
  post_run:
    name: 'cleanup-gh-workers'
    permissions:
      id-token: write
      contents: read
    runs-on: 'ubuntu-latest'
    steps:
    - name: Clone repo
      uses: actions/checkout@master
    - id: 'auth'
      uses: 'google-github-actions/auth@v0.4.0'
      with:
        workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_POOL_PROVIDER_NAME }} # this is the output provider_name from the TF module
        service_account: ${{ secrets.SVC_ACCOUNT_EMAIL }} # this is a SA email configured to create gh-runner MIGs
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.1.9
        terraform_wrapper: false
    - name: Terraform Init
      id: init
      run: |
        echo "bucket=\"${{ secrets.TF_BACKEND_BUCKET }}\"" > backend.tfvars
        terraform init -backend-config=backend.tfvars
      working-directory: ./test/setup/github-runners # Use your environment folder
      shell: bash
    - name: Terraform Destroy
      id: destroy
      run: |
        echo ${{ secrets.GH_RUNNER_TFVAR }} | base64 -d > terraform.tfvars
        terraform destroy -auto-approve
      working-directory: ./test/setup/github-runners # Use your environment folder
      shell: bash